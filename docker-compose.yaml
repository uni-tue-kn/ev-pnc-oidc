services:
  http-proxy:
    image: traefik:2.10
    ports:
      - 80:80/tcp
      - 443:443/tcp
    environment:
      INWX_USERNAME_FILE: /run/secrets/inwx_username
      INWX_PASSWORD_FILE: /run/secrets/inwx_password
      INWX_SHARED_SECRET_FILE: /run/secrets/inwx_secret
    command:
      - --accesslog=true
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.http.tls=true
      - --entrypoints.websecure.http.tls.certresolver=letsencrypt
      - --certificatesresolvers.letsencrypt.acme.email=jonas@primbs.is.it
      - --certificatesresolvers.letsencrypt.acme.storage=/etc/traefik/acme/acme.json
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.provider=inwx
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53
      - --providers.docker=true
      - --providers.docker.endpoint=unix:///var/run/docker.sock
      - --providers.docker.exposedbydefault=false
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - .secrets/acme:/etc/traefik/acme

  # op-discovery:
  #   build:
  #     context: ./discovery
  #     dockerfile: Dockerfile
  #   depends_on:
  #     - http-proxy
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.op-discovery.entrypoints=web"
  #     - "traefik.http.routers.op-discovery.rule=Host(`op.localhost`) && Path(`/.well-known/openid-configuration`)"
  #     - "traefik.http.routers.op-discovery.middlewares=op-discovery@docker"
  #     - "traefik.http.middlewares.op-discovery.replacepathregex.regex=^/.well-known/openid-configuration(.*)"
  #     - "traefik.http.middlewares.op-discovery.replacepathregex.replacement=$$1"

  emsp-backend:
    build:
      context: ./emsp-backend
      dockerfile: Dockerfile
    depends_on:
      - http-proxy
    labels:
      - traefik.enable=true
      - traefik.http.routers.emsp-backend.entrypoints=web,websecure
      - traefik.http.routers.emsp-backend.rule=Host(`emsp.oidcharge.primbs.dev`)
      - traefik.http.routers.emsp-backend.tls=true
      - traefik.http.routers.emsp-backend.tls.certresolver=letsencrypt

  emsp-as:
    build:
      context: ./emsp-authorizationserver
      dockerfile: Dockerfile
    depends_on:
      - http-proxy
    labels:
      - traefik.enable=true
      - traefik.http.routers.emsp-as.entrypoints=web,websecure
      - traefik.http.routers.emsp-as.rule=Host(`as.oidcharge.primbs.dev`)
      - traefik.http.routers.emsp-as.tls=true
      - traefik.http.routers.emsp-as.tls.certresolver=letsencrypt
    volumes:
      - ./emsp-authorizationserver/.:/authlete/app

  ev-backend:
    build:
      context: ./ev-backend
      dockerfile: Dockerfile
    depends_on:
      - http-proxy
    labels:
      - traefik.enable=true
      - traefik.http.routers.ev-backend.entrypoints=web
      - traefik.http.routers.ev-backend.rule=Host(`ev.localhost`)
    environment:
      - CSR_ENDPOINT=http://emsp-backend
      - OUTPUT_FILE=/output/cc.cer
      - API_KEY=${API_KEY}
      - API_SECRET=${API_SECRET}
    volumes:
      - cc_output:/output
      - ./ev-backend/config:/app/config

  user-agent:
    build:
      context: ./user-agent
      dockerfile: Dockerfile
    depends_on:
      - http-proxy
    labels:
      - traefik.enable=true
      - traefik.http.routers.user-agent.entrypoints=web,websecure
      - traefik.http.routers.user-agent.rule=Host(`ua.oidcharge.primbs.dev`)
      - traefik.http.routers.user-agent.tls=true
      - traefik.http.routers.user-agent.tls.certresolver=letsencrypt

volumes:
  cc_output:

secrets:
  inwx_username:
    file: .secrets/inwx_username.txt
  inwx_password:
    file: .secrets/inwx_password.txt
  inwx_secret:
    file: .secrets/inwx_secret.txt
