services:
  # # BLE Proxy
  # ble-proxy:
  #   build:
  #     context: ./ble-proxy
  #     dockerfile: Dockerfile
  #   privileged: true
  #   restart: unless-stopped
  #   networks:
  #     - ble_proxy
  #   environment:
  #     DEVICE_NAME: MyEV

  # EV Backend
  ev-backend:
    build:
      context: ./ev-backend
      dockerfile: Dockerfile
    restart: unless-stopped
    hostname: ev.localhost
    networks:
      - proxy
    # Disable this, when not testing behind the traefik reverse proxy:
    labels:
      # Make available on HTTP behind reverse proxy
      - traefik.enable=true
      - traefik.http.routers.ev-backend.entrypoints=web
      - traefik.http.routers.ev-backend.rule=Host(`${EV_BACKEND_DOMAIN}`)
      - traefik.http.routers.ev-backend.service=ev-backend
      - traefik.http.services.ev-backend.loadbalancer.server.port=80
    environment:
      # Configuration:
      PORT: 80
      CSR_ENDPOINT: https://${EMSP_BACKEND_DOMAIN}/csr
      OUTPUT_FILE: /app/output/cc.cer
    volumes:
      # Output directory with certificates:
      - ./.secrets:/app/output
      # Configuration directory:
      - ./ev-backend/config:/app/config

networks:
  # Network between Reverse Proxy and services
  # # Use this, when running on the Raspberry Pi behind the Bluetooth LE proxy:
  # proxy:
  #   driver: bridge
  # Use this, when testing directly via HTTP on the same device as the servers:
  proxy:
    external: true
    name: emsp_proxy
